#include "../include/game.hpp"

Game::Game() : 
    Player1(Point2d((MIN_X + MAX_X)/2 - (PLAYER_WIDTH / 2), 0), Point2d(0, 0), Point2d(0, ACCELERATION)),
    isStarted(0),
    gameTime(0.0f),
	floorCounter(5)
{

    this->floors[0] = Line2d( Point2d(MIN_X,0), Point2d(MAX_X, 0) );

    for(int i = 1; i < N_FLOORS; i++){
    	this->floors[i] = Line2d::RandomLine(200, 600, MIN_X, MAX_X, FLOOR_SPACING * i);
    }
}

void Game::Display(){

}

#include "xparameters.h"
#define KEY_SPACE (1 << 0)
#define KEYBOARD_BASE		XPAR_KEYBOARDCONTROLLER_0_S00_AXI_BASEADDR
#define KEYBOARD_KEYS		(*(uint16_t*)(KEYBOARD_BASE + 0))

void Game::Run(){

	if(KEYBOARD_KEYS & KEY_SPACE){
		this->Player1.changePosition(Point2d(0, 5));
		this->isStarted = 1;
	}

	this->Player1.calculateNextPosition(0.01);
	if(this->Player1.getPosition().GetY() < -64){
		this->Player1.setPosition( this->Player1.getPosition() * Point2d(1,0) );
	}

	if(this->isStarted){
		for(int i = 0; i < N_FLOORS; i++){
			if(this->floorCounter % 100){
				if (this->floors[i].moveDown(1,-FLOOR_HEIGHT,MAX_Y, false) ) this->floorCounter++;
			}
			else{
				if (this->floors[i].moveDown(1,-FLOOR_HEIGHT,MAX_Y, true) ) this->floorCounter++;
			}
		}
	}

}

Line2d Game::GetFloor(int FloorIndex){return this->floors[FloorIndex];};
Player Game::GetPlayer(){return this->Player1;};
